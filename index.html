<!DOCTYPE html>
<html>
<head>
<title>websocket client</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<meta charset="utf-8"/>
<style type="text/css">
body{
	padding:0;
	margin:0;
	background-color: #000000;
	background-image: linear-gradient(315deg, #000000 0%, #414141 74%);	
}
#gameBox{
	overflow:hidden;
}
#lobby{
	position:absolute;
	top:0;
	left:0;
	display:flex;
	width:100%;
	height:calc(var(--vh, 1vh) * 100);
	align-items:center;
	justify-content:center;
	flex-direction:column;
	background-color: #485461;
	background-image: linear-gradient(315deg, #485461 0%, #28313b 74%);	
}
button:active{
	transform:scale(0.9);
	transition:transform 100ms linear;
}
.roomAutomation{
	display:flex;
	align-items:center;
	justify-content:space-around;
	flex-direction:column;
	width:85%;
	max-width:800px;
	border-radius:10px;
	padding: 20px 1%;
	background:#538adc;
	background:#ba1c0f;
	background:#222;
	box-shadow:0 0 10px #aaa;
}
#roomsBox{
	display:flex;
	align-items:center;
	justify-content:flex-start;
	flex-direction:column;
	width:92%;
	max-width:800px;
	height:30vh;
	min-height:100px;
	background:white;
	border-radius:8px;
	overflow-y:auto;
	border:2px solid rgba(0,0,0,0.8);
	box-shadow:inset 0 0 5px rgba(0,0,0,0.6);
}
.roomBox{
	display:flex;
	align-items:center;
	justify-content:space-between;
	flex-direction:row;
	border-bottom: 3px solid #222;
	width:100%;
	/*background:linear-gradient(70deg,red,orange);*/
	user-select:none;
}
.roomBox:nth-child(odd){
background:#eb760c;
}
.roomBox:nth-child(even){
background:#faa814;
}
.roomBox:active,.roomBox.selected{
	background:linear-gradient(190deg,red,orange);
}
.roomBox .number,.roomBox .pCount{
	display:flex;
	align-items:center;
	justify-content:center;
	font-size:1.3em;
	padding:0.5em;
	font-weight:900;
	border-right:2px solid #222;
	color:#222;
}
.roomBox .info{
	display:flex;
	justify-content:space-around;
	flex-direction:column;
	width:100%;
	height:100%;
	padding: 0 0.5em;
	color:#222;
}
.roomBox .pCount{
border:none;
border-left:2px solid #222;
}
.roomBtn{
	display:flex;
	align-items:center;
	justify-content:space-around;
	width:92%;
	padding:10px;
}
.roomBtn button,#alert1 button{
	font-size:1em;
	font-weight:900;
	padding:6px;
	border-radius:5px;
	border:none;
	user-select:none;
	background: linear-gradient(145deg, #ffbd00, #df9f00);
	box-shadow:	0 0 5px #e2a100,
				0 0 5px #ffc100;
}
.roomBtn button:active, #alert1 button:active{
	transform:scale(0.9);
	transition:transform 100ms linear;
	background: linear-gradient(145deg, #e69e00, #ffbb00);
	box-shadow:	0  0 5px #e89f00,
				0 0 5px #ffbf00;
}
#alert1{
	position:absolute;
	top:50%;
	left:50%;
	transform:translate(-50%,-50%);
	width:70vw;
	min-width:200px;
	max-width:500px;
	min-height:120px;
	display:flex;
	align-items:space-around;
	justify-content:space-around;
	flex-direction:column;
	padding:1em;
	background:linear-gradient(190deg,#555,#333);
	border-radius:20px;
	z-index:999;
	box-shadow:	inset 0 0 8px #000;
	border:1px solid rgba(255,255,255,0.5);
}
#userRoomName{
	font-size:1.2em;
	padding:4px;
	border-color:#000;
	border-style:solid;
}
#userRoomName.red{
	border-color:#f00;
}
#userRoomName.red::placeholder{
	color:#f00;
}
#blackLayer{
position:fixed;
top:0;
left:0;
width:100%;
height:150%;
background:rgba(0,0,0,0.8);
z-index:99;
}
#chatSystem{
	position:fixed;
	top:0;
	right:0;
	background:#444;
	display:flex;
	flex-direction:column;
	width:300px;
	height:100%;
	transition:right 200ms ease-in-out;
	box-shadow:inset 0 0 8px #fff;
}
#chatSystem.closed{
	right:-300px;
}
#chatSystem #toggle svg path{
	d:path('M50,25 L75,50 L50,75');
}
#chatSystem.closed #toggle svg path{
	d:path('M50,25 L25,50 L50,75');
}
#toggle{
	position:absolute;
	top:50%;
	left:-30px;
	transform:translateY(-50%);
	display:flex;
	align-items:center;
	justify-content:center;
	width:30px;
	height:80px;
	background:orange;
	color:#fff;
	transform-origin:100% 50%;
	user-select:none;
	border-radius:50%;
	border-radius: 500px 0px 0px 500px;

}
#toggle:active{
	transition:transform 100ms linear;
	transform:translateY(-50%) scale(0.9);
}
#toggle svg{
	width:100%;
	height:100%;
}
.modeBox{
	display:flex;
	flex-direction:row;
	width:100%;
}
.modeBox button{
	width:50%;
	font-size:1.2em;
	font-weight:900;
	user-select:none;
	background:rgba(0,0,0,0.3);
	color:#fff;
	border:none;
}
.modeBox button.active{
	background:orange;
	color:#000;
}
#globalBox,#privateBox{
	display:flex;
	flex-direction:column;
	justify-content:flex-start;
	height:100%;
	width:100%;
	overflow:auto;
	box-sizing:border-box;
	padding:10px;
}
#privateBox{
	display:none;
}
.userInputBox{
	display:flex;
	width:100%;
}
.userInputBox input{
	width:100%;
	font-size:1.2em;
}
.userInputBox button{
	font-size:1.2em;
}
#chatSystem .msgBox{
	display:flex;
	width:100%;
	margin:4px 0;
}
#chatSystem .msgBox.me{
	justify-content:flex-end;
}
#chatSystem .msgBox.other{
	justify-content:flex-start;
}
#chatSystem .msgBox .msg{
	display:flex;
	align-items:space-around;
	justify-content:space-around;
	flex-direction:column;
	background:skyblue;
	border-radius:6px;
	min-width:20%;
	max-width:80%;
	padding:5px;
}
#chatSystem .msgBox.me .msg{
	background:#ff8;	
}
#chatSystem .msgBox h3{
	margin:0;
	padding:0;
}
#chatSystem .msgBox.me h3{
display:none;
}
#chatSystem .msgContent{
	overflow-y:auto;
	max-height:300vh;
	overflow-wrap: break-word;
	word-wrap: break-word;
	-ms-word-break: break-all;
	word-break: break-all;
	word-break: break-word;
	-ms-hyphens: auto;
	-moz-hyphens: auto;
	-webkit-hyphens: auto;
	hyphens: auto;
}
#myRoomBox{
	position:absolute;
	top:0;
	left:0;
	width:100%;
	height:100%;
}
#membersBox{
	position:absolute;
	top:50%;
	left:50%;
	transform:translate(-50%,-50%);
	display:flex;
	align-items:space-around;
	justify-content:space-around;
	flex-direction:row;
	flex-wrap:wrap;
	width:500px;
	max-width:80%;
}
#membersBox .member{
	position:relative;
	background:#777;
	box-shadow:inset 0 0 0.6em #000;
	width:20%;
	height:auto;
	margin:2.5%;
	color:#ddd;
	padding:0;
}
#membersBox .member img{
	width:100%;
	height:auto;
}
#membersBox .member .content{
	position:absolute;
	top:0;
	left:0;
	width:100%;
	height:100%;
	display:flex;
	align-items:center;
	justify-content:center;
}
#membersBox .member.ready{
	background:radial-gradient(circle,green,darkgreen);
}
#membersBox .member.unready{
	background:radial-gradient(circle,red,darkred);
}
#membersBox .member.battling{
	background:radial-gradient(circle,orange,gold);
}
.bottomSection{
	position:absolute;
	bottom:0;
	left:0;
	width:100%;
	display:flex;
	align-items:center;
	justify-content:center;
}
.bottomSection button{
	width:50%;
	font-size:1.2em;
}
@keyframes chatPath{
	0%{
		d:path('M50,25 L25,50 L50,75');
	}
	100%{
		d:path('M50,25 L75,50 L50,75');
	}
}
@media (min-width:700px){
	body{
		font-size:30px;
	}
}
</style>
</head>
<body>
<div id="lobby">
	<section class="roomAutomation">
		<div id="roomsBox">
			<!--div class="roomBox">
				<span class="number">1</span>
				<div class="info">
					<span>Name: joinPlz</span>
					<span>Mode: duo</span>
				</div>
				<span class="pCount">4/6</span>
			</div-->
		</div>
		<div class="roomBtn">
			<button onclick="alert1.style.display = 'flex';blackLayer.style.display='block';userRoomName.focus();">Create Room</button>
			<button onclick="joinRoom(selectedRm);">Join Room</button>
		</div>	
	</section>
	<section id="myRoomBox" style="display:none;">
		<div id="membersBox">
			<!--div class="member ready">
				<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII="/>
				<div class="content">user1</div>
			</div-->
		</div>
		<div class="bottomSection">
			<button onclick="leaveRoom();">leave</buttton>
			<button onclick="changeReady();">Ready</button>
		</div>
	</section>
	<section id="chatSystem" class="closed">
		<div id="toggle" onclick="chatSystem.classList.toggle('closed');if(chatSystem.className!='closed'){chatPath.style.animation = 'chatPath 200ms linear forwards';}else{chatPath.style.animation = 'chatPath 200ms linear reverse';}">
			<svg viewBox="0 0 100 100">
				<path id="chatPath" d="M50,25 L25,50 L50,75" stroke="#fff" fill="transparent" stroke-width="8"/>
			</svg>
		</div>
		<div class="modeBox">
			<button id="globalBtn" onclick="openBox(this,'global')" class="active">global</button>
			<button id="privateBtn" onclick="openBox(this,'room')">room</button>
		</div>
		<div id="globalBox"></div>
		<div id="privateBox"></div>
		<div class="userInputBox">
			<input id="userInput" type="text" placeholder="Type a message"/>
			<button id="sendBtn">send</button>
		</div>
	</section>
	<div id="alert1" style="display:none;">
		<input id="userRoomName" type="text" placeholder="Room Name (1-15 chars)"/>
		<select id="modesSelect"></select>
		<button onclick="createRoom();">create</buttom>
	</div>
</div>

<div id="gameBox" style="display:none">
	<canvas id="canvas"></canvas>
</div>
<div id="blackLayer" style="display:none;"></div>
<script>function addScr(n,d){var e=document.createElement("script");e.src=n,document.body.appendChild(e),e.onload=function(){d()}}addScr("https://cdn.jsdelivr.net/npm/eruda@2.4.1/eruda.min.js",function(){eruda.init()});</script>
<script type="text/javascript">
var url = "ws://https://lid-multigame.glitch.me/";
var ws = new WebSocket(url);
var myId = "me";
var selectedRm = -1;

var c = document.getElementById("canvas");
var ctx = c.getContext("2d");
var lastGame = "";

var roomsBox = document.getElementById("roomsBox");
var myRoomBox = document.getElementById("myRoomBox");
var hostRoom = document.getElementById("hostRoom");
var alert1 = document.getElementById("alert1");
var roomAutomation = document.getElementsByClassName("roomAutomation")[0];
var chatSystem = document.getElementById("chatSystem");
var toggle = document.getElementById("toggle");
var globalBox = document.getElementById("globalBox");
var privateBox = document.getElementById("privateBox");
var globalBtn = document.getElementById("globalBtn");
var privateBtn = document.getElementById("privateBtn");
var userInput = document.getElementById("userInput");
var sendBtn = document.getElementById("sendBtn");
var gameBox = document.getElementById("gameBox");
var lobby = document.getElementById("lobby");
var membersBox = document.getElementById("membersBox");
var chatPath = document.getElementById("chatPath");

var xoInfo = {
	box:{x:0,y:0,size:0},
	gameData:[-1,-1,-1,-1,-1,-1,-1,-1,-1],
	lineWidth:0,
	isClientTurn:false,
	turn:"",
	rBtns:[new RBtn(),new RBtn(),new RBtn(),new RBtn(),new RBtn(),new RBtn(),new RBtn(),new RBtn(),new RBtn()]
}
for(var i=0;i<xoInfo.rBtns.length;i++){
	xoInfo.rBtns[i].onclick = addEvent(i);
}
function addEvent(i){
	return function(){
		xoPlay(i);
	}
}

var castlesInfo = {
	box:{x:0,y:0,width:0,height:0},
	castles:[],
	armies:[],
};

alert1.getData = function(){
	var userRoomName = document.getElementById("userRoomName");
	var modesSelect = document.getElementById("modesSelect");
	return {
		roomName:userRoomName.value,
		modeName:modesSelect.value
	};
}
var blackLayer = document.getElementById("blackLayer");

var temp,tx=0;
var lastTouchstart=0;
toggle.addEventListener("touchstart",function(e){
	lastTouchstart = Date.now();
	temp = chatSystem.style.transition;
	chatSystem.style.transition = "all 5ms linear";
});
toggle.addEventListener("touchmove",function(e){
	tx = Math.min(e.touches[0].clientX*-1+window.innerWidth,chatSystem.clientWidth);
	chatSystem.style.right = (tx-chatSystem.clientWidth)+"px";
});
toggle.addEventListener("touchend",function(e){
	chatSystem.style.transition = temp;
	chatSystem.removeAttribute("style");
	var et = Date.now() - lastTouchstart;
	if(tx<chatSystem.clientWidth/2 && et>160){
		chatSystem.classList.add("closed");
	}
	else if(et>160){
		chatSystem.classList.remove("closed");
	}
});
toggle.addEventListener("touchcancel",function(e){
	chatSystem.style.transition = temp;
	chatSystem.removeAttribute("style");
	var et = Date.now() - lastTouchstart;
	if(tx<chatSystem.clientWidth/2 && et>160){
		chatSystem.classList.add("closed");
	}
	else if(et>160){
		chatSystem.classList.remove("closed");
	}
});
chatPath.addEventListener("animationend",function(){
	chatPath.style.animation = "";
});
var lastBlurTime;
userInput.addEventListener("blur",function(){
	if(oBox=="global"){globalBox.scrollTo(0,globalBox.scrollHeight);}
	if(oBox=="room"){privateBox.scrollTo(0,privateBox.scrollHeight);}
});
userInput.addEventListener("blur",function(){lastBlurTime=Date.now();});
sendBtn.addEventListener("click",function(){
	if(userInput.value.length > 0){
		if(oBox === "global"){
			sendMsg("globalMessage",userInput.value);
		}
		else if(oBox === "room"){
			sendMsg("roomMessage",userInput.value);
		}
		userInput.value = "";
	}
	if(Date.now()-lastBlurTime<100){
		userInput.focus();
	}
});
var oBox = "global";
function openBox(el,str){
	oBox = str;
	if(str == "global"){
		globalBox.style.display = "flex";
		privateBox.style.display = "none";
		globalBtn.classList.add("active");
		privateBtn.classList.remove("active");
	}
	else if(str == "room"){
		globalBox.style.display = "none";
		privateBox.style.display = "flex";
		globalBtn.classList.remove("active");
		privateBtn.classList.add("active");
	}

}

ws.onopen = function(){}
ws.onmessage = function(msg){
	var msgData = JSON.parse(msg.data);
	switch(msgData.type){
		case "name":
			myId = msgData.content;
			break;
		case "console":
			console.log(msgData.content);
			break;
		case "alert":
			alert(msgData.content);
			break;
		case "games":
			var modesSelect = document.getElementById("modesSelect");
			for(var i=0;i<msgData.content.length;i++){
				modesSelect.insertAdjacentHTML("beforeend",'<option value="'+msgData.content[i]+'">'+msgData.content[i]+'</option>');
			}
			break;
		case "roomsInfo":
			if(msgData.content.type === "allRooms"){
				var rooms = msgData.content.rooms;
				var roomBoxes = document.getElementsByClassName("roomBox");
				for(var i=0;i<rooms.length;i++){
					if(roomBoxes[i]){
						roomBoxes[i].childNodes[2].innerHTML = rooms[i].playersLength+"/"+rooms[i].maxCapacity;
						roomBoxes[i].childNodes[1].childNodes[0].innerHTML = "Name: "+rooms[i].name;
						roomBoxes[i].childNodes[1].childNodes[1].innerHTML = "Mode: "+rooms[i].mode;
					}
					else{
						var html = '<div class="roomBox" onclick="selectRoom(this);"><span class="number">'+(i+1)+'</span><div class="info"><span>Name: '+rooms[i].name+'</span><span>Mode: '+rooms[i].mode+'</span></div><span class="pCount">'+rooms[i].playersLength+'/'+rooms[i].maxCapacity+'</span></div>';
						roomsBox.insertAdjacentHTML("beforeend",html);
						var roomBox = document.getElementsByClassName("roomBox");
					}
				}
				for(var i=rooms.length;i<roomBoxes.length;i++){
					roomBoxes[i].parentNode.removeChild(roomBoxes[i]);
					i--;
				}
			}else if(msgData.content.type === "yourRoom"){
				var members = msgData.content.members;
				var memberBoxes = document.getElementsByClassName("member");
				for(var i=0;i<msgData.content.maxCapacity;i++){
					var memberClass = "unready";
					var id;
					if(members[i]){
						if(members[i].status == 1){memberClass="ready";}
						else if(members[i].status == 2){memberClass="battling";}
						id=members[i].id;
					}
					else{memberClass=id="";}
					if(memberBoxes[i]){
						memberBoxes[i].children[1].innerHTML = id;
						memberBoxes[i].className = "member "+memberClass;
					}
					else{
						var html = '<div class="member '+memberClass+'"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII="/><div class="content">'+id+'</div></div>';
						membersBox.insertAdjacentHTML("beforeend",html);
					}
				}
				for(var i=msgData.content.maxCapacity;i<memberBoxes.length;i++){
					memberBoxes[i].parentNode.removeChild(memberBoxes[i]);
					i--;
				}
			}
			break;
		case "goToRoom":
			lobby.style.display = "flex";
			roomAutomation.style.display = "none";
			myRoomBox.style.display = "flex";
			gameBox.style.display = "none";
		break;
		case "backToRoom":
			setTimeout(function(){
				lobby.style.display = "flex";
				roomAutomation.style.display = "none";
				myRoomBox.style.display = "flex";
				gameBox.style.display = "none";
				cancelAnimationFrame(animate);
			},1000);
			break;
		case "goToGame":
			lobby.style.display = "none";
			roomAutomation.style.display = "none";
			myRoomBox.style.display="none";
			gameBox.style.display = "block";
			lastGame = msgData.content;
			switch(lastGame){
				case "Tic Tac Toe":xoBoxResize();break;
				case "Castles":castlesBoxResize();break;
			}
			requestAnimationFrame(animate);
			break;
		case "backToRooms":
			lobby.style.display = "flex";
			roomAutomation.style.display = "flex";
			myRoomBox.style.display = "none";
			gameBox.style.display = "none";
			break;
		case "globalMessage":
			var scroll = Math.floor(globalBox.scrollTop+globalBox.clientHeight)==globalBox.scrollHeight;
			var html = '<div class="msgBox '+msgData.content.classes+'"><div class="msg"><h3 class="msgSender">'+msgData.content.sender+'</h3><p class="msgContent">'+msgData.content.content+'</p></div></div>';
			globalBox.insertAdjacentHTML("beforeend",html);
			if(scroll){globalBox.scrollTo(0,globalBox.scrollHeight);}
			break;
		case "roomMessage":
			var scroll = Math.floor(privateBox.scrollTop+privateBox.clientHeight)==privateBox.scrollHeight;
			var html = '<div class="msgBox '+msgData.content.classes+'"><div class="msg"><h3 class="msgSender">'+msgData.content.sender+'</h3><p class="msgContent">'+msgData.content.content+'</p></div></div>';
			privateBox.insertAdjacentHTML("beforeend",html);
			if(scroll){privateBox.scrollTo(0,privateBox.scrollHeight);}
			break;
		case "xoInfo":
			console.log(msgData);
			for(var i=0;i<msgData.content.gameData.length;i++){
				xoInfo.gameData[i] = msgData.content.gameData[i];
			}
			xoInfo.isClientTurn = msgData.content.isClientTurn;
			xoInfo.turn = msgData.content.turn;
			break;
		case "castlesInfo":
			castlesInfo.castles = msgData.content.castles;
			castlesInfo.armies = msgData.content.armies;
			castlesInfo.myIndex = msgData.content.myIndex;
			break;
		default:
		alert("new: "+msgData.type);
	}
	
}
var castlesColor = ["red","yellow","#05a","white","lime","cyan","pink","orange"];
function animate(){
	switch(lastGame){
		case "Tic Tac Toe":
			var box = xoInfo.box;
			ctx.clearRect(0,0,c.width,c.height);
			ctx.fillStyle = ctx.strokeStyle = "#fff";
			ctx.lineWidth = xoInfo.lineWidth;
			for(var i=1;i<3;i++){
				ctx.beginPath();
				ctx.moveTo(box.x+i*box.size/3,box.y);
				ctx.lineTo(box.x+i*box.size/3,box.y+box.size);
				ctx.closePath();
				ctx.stroke();
			}
			for(var j=1;j<3;j++){
				ctx.beginPath();
				ctx.moveTo(box.x,box.y+j*box.size/3);
				ctx.lineTo(box.x+box.size,box.y+j*box.size/3);
				ctx.closePath();
				ctx.stroke();
			}
			ctx.font = (box.width/6)+"px Arial";
			ctx.textAlign = "center";
			ctx.textBaseline = "bottom";
			if(xoInfo.isClientTurn){
				ctx.fillText("your turn",window.innerWidth/2,xoInfo.box.y-20);
			}else{
				ctx.fillText(xoInfo.turn+"'s turn",window.innerWidth/2,xoInfo.box.y-20);
			}
			ctx.textBaseline = "middle";
			for(var i=0;i<xoInfo.gameData.length;i++){
				var text = xoInfo.gameData[i];
				if(text === -1){text = "";}
				else if(text === 0){text = "x";}
				else if(text === 1){text = "o";}
				var x = i % 3;
				var y = Math.floor(i / 3);
				ctx.fillText(text,xoInfo.box.x + x*xoInfo.box.size/3+xoInfo.box.size/6,xoInfo.box.y + y*xoInfo.box.size/3+xoInfo.box.size/6);
			}
			requestAnimationFrame(animate);
			break;
		case "Castles":
			var box = castlesInfo.box;
			ctx.clearRect(0,0,c.width,c.height);
		//	ctx.strokeRect(box.x,box.y,box.width,box.height);
			ctx.save();
			ctx.translate(box.x,box.y);
			ctx.strokeStyle = "#aaa";
			ctx.lineWidth = box.width/15;
			for(var i=0;i<castlesInfo.castles.length;i++){
				var castle = castlesInfo.castles[i];
				for(var j=0;j<castle.nearCastles.length;j++){
					var nearCastle = castlesInfo.castles[castlesInfo.castles[i].nearCastles[j]];
					ctx.beginPath();
					ctx.moveTo(castle.pos.x*box.width,castle.pos.y*box.height);
					ctx.lineTo(nearCastle.pos.x*box.width,nearCastle.pos.y*box.height);
					ctx.stroke();
					ctx.closePath();
				}
			}
			for(var i=0;i<castlesInfo.castles.length;i++){
				var castle = castlesInfo.castles[i];
				for(var j=0;j<castle.nearCastles.length;j++){
					var nearCastle = castlesInfo.castles[castlesInfo.castles[i].nearCastles[j]];
					var angle = calculateAngle(new Vec2(castle.pos.x,castle.pos.y*1.5),new Vec2(nearCastle.pos.x,nearCastle.pos.y*1.5));
					var distance = calculateDistance(new Vec2(castle.pos.x,castle.pos.y*1.5),new Vec2(nearCastle.pos.x,nearCastle.pos.y*1.5));
					ctx.translate(castle.pos.x*box.width,castle.pos.y*box.height);
					ctx.rotate(angle);
					ctx.beginPath();
					ctx.moveTo(0,0);
					ctx.lineTo((distance/2)*box.width,0);
					ctx.strokeStyle = castlesColor[castle.player];
					if(castle.team != -1){
						ctx.globalAlpha = 0.5;
						ctx.stroke();
						ctx.globalAlpha = 1.0;
					}
					ctx.closePath();
					if(castle.player == castlesInfo.myIndex){
					drawArrow(0.05*box.width,0,0.10*box.width,0,box.width/50,box.width/500,"rgba(255,255,255,0.9)");
					}
					ctx.rotate(-angle);
					ctx.translate(-castle.pos.x*box.width,-castle.pos.y*box.height);
				}
			}
			for(var i=0;i<castlesInfo.armies.length;i++){
				var army = castlesInfo.armies[i];
				ctx.beginPath();
				ctx.arc(army.pos.x*box.width,army.pos.y*box.height,0.1*box.width*(army.value/18),0,2*Math.PI);
				ctx.fillStyle = castlesColor[army.originCastle.player] || "#888";
				ctx.fill();
				ctx.closePath();
			}
			ctx.textAlign = "center";
			ctx.textBaseline = "middle";
			for(var i=0;i<castlesInfo.castles.length;i++){
				var castle = castlesInfo.castles[i];
				ctx.beginPath();
				ctx.shadowBlur = box.width/30;
				ctx.shdowColor = "rgba(0,0,0,1)";
				drawRegPolygon(castle.pos.x*box.width,castle.pos.y*box.height,0.1*box.width*(castle.value/18),6);
				ctx.fillStyle = castlesColor[castle.player] || "#888";
				ctx.fill();
				ctx.closePath();
				ctx.shadowBlur = 0;
				ctx.shdowColor = "rgba(0,0,0,0)";
				ctx.font = ((box.width/7)*(castle.value/18))+"px Arial";
				ctx.globalCompositeOperation = "difference";
				ctx.fillStyle = "#fff";
				var txt = "";
				if(castle.team!=-1){txt = (castle.team+1).toString();}
				ctx.fillText(txt,castle.pos.x*box.width,castle.pos.y*box.height);
				ctx.globalCompositeOperation = "source-over";
			}
			ctx.restore();
			requestAnimationFrame(animate);
			break;
	}
}
function drawArrow(fromx, fromy, tox, toy, arrowWidth,headlen, color){
	var angle = Math.atan2(toy-fromy,tox-fromx);
	ctx.save();
	ctx.strokeStyle = color;
	ctx.beginPath();
	ctx.moveTo(fromx, fromy);
	ctx.lineTo(tox, toy);
	ctx.lineWidth = arrowWidth;
	ctx.stroke();
	ctx.beginPath();
	ctx.moveTo(tox, toy);
	ctx.lineTo(tox-headlen*Math.cos(angle-Math.PI/7),toy-headlen*Math.sin(angle-Math.PI/7));
	ctx.lineTo(tox-headlen*Math.cos(angle+Math.PI/7),toy-headlen*Math.sin(angle+Math.PI/7));
	ctx.lineTo(tox, toy);
	ctx.lineTo(tox-headlen*Math.cos(angle-Math.PI/7),toy-headlen*Math.sin(angle-Math.PI/7));
	ctx.stroke();
	ctx.restore();
}
function calculateAngle(v1,v2){
	var dx = v2.x - v1.x;
	var dy = v2.y - v1.y;
	return Math.atan2(dy,dx);
}
function calculateDistance(v1,v2){
	var dx = v2.x - v1.x;
	var dy = v2.y - v1.y;
	return Math.sqrt(dx*dx+dy*dy);
}
function xoBoxResize(){
	xoInfo.box.size = Math.min(window.innerWidth*0.85,window.innerHeight*0.85);
	xoInfo.box.x = window.innerWidth/2 - xoInfo.box.size/2;
	xoInfo.box.y = window.innerHeight/2 - xoInfo.box.size/2;
	xoInfo.lineWidth = xoInfo.box.size*0.05;
	for(var i=0;i<xoInfo.rBtns.length;i++){
		var x = i % 3;
		var y = Math.floor(i / 3);
		xoInfo.rBtns[i].box.x = xoInfo.box.x + x*xoInfo.box.size/3;
		xoInfo.rBtns[i].box.y = xoInfo.box.y + y*xoInfo.box.size/3;
		xoInfo.rBtns[i].box.width = xoInfo.box.size/3;
		xoInfo.rBtns[i].box.height = xoInfo.box.size/3;
	}
}
function castlesBoxResize(){
	var ar = window.innerWidth/window.innerHeight;
	var v;
	if(ar>=0.75){
		v = {w:window.innerHeight*0.75,h:window.innerHeight};
	}else{
		v = {w:window.innerWidth,h:window.innerWidth*1.5};
	}
	castlesInfo.box.x = window.innerWidth/2 - v.w/2;
	castlesInfo.box.y = window.innerHeight/2 - v.h/2;
	castlesInfo.box.width = v.w;
	castlesInfo.box.height = v.h;
}
function changeCssVar(varName,val){
	document.documentElement.style.setProperty(varName, val);
}
window.addEventListener("load",function(){
	changeCssVar("--vh",(window.innerHeight * 0.01)+"px");
	c.width = window.innerWidth;
	c.height = window.innerHeight;
});
window.addEventListener("resize",function(){
	changeCssVar("--vh",(window.innerHeight * 0.01)+"px");
	c.width = window.innerWidth;
	c.height = window.innerHeight;
	switch(lastGame){
		case "Tic Tac Toe":xoBoxResize();break;
		case "Castles":castlesBoxResize();break;
	}
});
function xoPlay(cellIndex){
	sendMsg("xoPlay",cellIndex);
}
function joinRoom(num){
	if(selectedRm != -1){
		sendMsg("joinRoom",num);
	}else{
		alert("please select a room first");
	}
}
function leaveRoom(){
	sendMsg("leaveRoom");
}
function createRoom(){
	var userRoomName = document.getElementById("userRoomName");
	var data = alert1.getData();
	if(data.roomName.length>0 && data.roomName.length<=15){
		userRoomName.className = "";
		userRoomName.value = "";
		alert1.style.display = "none";
		blackLayer.style.display = "none";
		sendMsg("createRoom",data);
	}else{
		userRoomName.value = "";
		userRoomName.className = "red";
	}
}
function changeReady(){
	sendMsg("ready");
}
function drawRegPolygon(x,y,radius,sides){
	ctx.beginPath();
	ctx.moveTo(x + radius * Math.cos(0),y + radius * Math.sin(0));          
	for(var i=1;i<=sides;i++){
		ctx.lineTo(x + radius * Math.cos(i * 2 * Math.PI / sides),y + radius * Math.sin(i * 2 * Math.PI / sides));
	}
}
function selectRoom(el){
	var roomBox = document.getElementsByClassName("roomBox");
	for(var i=0;i<roomBox.length;i++){
		if(roomBox[i] === el){
			selectedRm = i;
			roomBox[i].className = "roomBox selected";
		}else{
			roomBox[i].className = "roomBox";
		}
		
	}
}
function sendMsg(type,content,more){
	var msg = {
		type:type,
		content:content
	}
	for(var el in more){
		msg[el] = more[el];
	}
	ws.send(JSON.stringify(msg));
}
c.addEventListener("click",function(e){
	var click = new Vec2(e.clientX,e.clientY);
	switch(lastGame){
		case "Tic Tac Toe":
			for(var i=0;i<xoInfo.rBtns.length;i++){
				if(xoInfo.rBtns[i].checkClick(click)){
					xoInfo.rBtns[i].onclick();
				}
			}
			break;
		case "Castles":
			castlesClick(click);
			break;
		default:alert("new: "+lastGame);
	}
});
function castlesClick(v){
	var min = undefined;
	var index = 0;
	for(var i=0;i<castlesInfo.castles.length;i++){
		var dx = ((v.x-castlesInfo.box.x)/castlesInfo.box.width) - castlesInfo.castles[i].pos.x;
		var dy = ((v.y-castlesInfo.box.y)/castlesInfo.box.height)*1.5 - castlesInfo.castles[i].pos.y*1.5;
		var dis = Math.sqrt(dx*dx+dy*dy);
		if(min === undefined || min>dis){
			min = dis;
			index = i;
		}
	}
	if(min<0.15){
		var castle = castlesInfo.castles[index];
		var tdx = ((v.x-castlesInfo.box.x)/castlesInfo.box.width) - castle.pos.x;
		var tdy = ((v.y-castlesInfo.box.y)/castlesInfo.box.height)*1.5 - castle.pos.y*1.5;
		var touchAngle = Math.atan2(tdy,tdx);
		var difAngle = null;
		var arrayIndex = 0;
		for(var i=0;i<castlesInfo.castles[index].nearCastles.length;i++){
			var nearCastle = castlesInfo.castles[castlesInfo.castles[index].nearCastles[i]];
			var cdx = nearCastle.pos.x - castle.pos.x;
			var cdy = nearCastle.pos.y*1.5 - castle.pos.y*1.5;
			var exactAngle = Math.atan2(cdy,cdx);
			var dif = Math.abs(touchAngle - exactAngle);
			if(difAngle === null || difAngle>dif){
				difAngle = dif;
				arrayIndex = i;
			}
		}
		var destinationIndex = castle.nearCastles[arrayIndex];
		if(Math.abs(difAngle*180/Math.PI) <= 20){
			sendMsg("castlesPlay",{originCastle:index,destinationCastle:destinationIndex});
		}
	}
}
function RBtn(x,y,w,h){
	this.shape = "rect";
	this.box = {};
	this.box.x = x || 0;
	this.box.y = y || 0;
	this.box.width = w || 0;
	this.box.height = h || 0;
	this.onclick = this.ontouchstart = this.ontouchmove = this.ontouchend = this.ontouchcancel = this.onmouseenter = this.onmouseleave = function(){}
	this.checkClick = function(v){
		return this.box.x<v.x && this.box.x+this.box.width>v.x && this.box.y<v.y && this.box.y+this.box.height>v.y;
	}
}
function Vec2(x,y){
	this.x = x;
	this.y = y;
}
</script>
</body>
</html>
